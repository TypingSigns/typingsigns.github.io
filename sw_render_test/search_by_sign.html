<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<script src="jquery.min.js"></script>
	<script src="sifter.js"></script>

	<script src="2_sgn4.js"></script>
	<script src="swRootSymbolCategories.js"></script>

	<!-- Note: Currently only runs on Chrome. (SAFARI has font-handling issues with SignWriting 2010) Future ToDo: Add disclaimer if opened in safari. (Also test on chrome mobile. -->

	<!-- Next: Find a way to surface all possible results.  -->

	<!-- Misc Future Potenital ToDos:
		- remove excessive unicode8 symbols, from the regex search of an FSW-string.
		- create a font of single-characters u8 symbols with corrected height.
		- Use own Server for rendering icons. Or pre-render and store them locally.
		- Allow images to be dragged out (e.g. PNGs)
	 -->
<style>
@font-face {
  font-family: "SignWriting 2010";
  src: 
  	local('SignWriting 2010'),
  	url('SignWriting 2010.ttf') format('truetype');
  /* If positioning issue reoccurs, stop using local font. (msg expires 2016-10-10) */
}

html, body {
	height: 100%;
	margin: 0; padding: 0;
}
body {
	font-family: Helvetica, "SignWriting 2010", Serif;
	position: relative;
}
#content-wrapper {
	height: 100%;
}
	#upper-wrapper {
		background-color: lightblue;
		/* height is set via js according to keyboard-area's height */
		overflow: auto;
		text-align: center;
	}
	#keyboard-area {
		border-top: 1px solid black;
		background-color: #ccc;
		padding: 5px;
	}

#inputArea {
	margin: 5px 0;
	width: 100%;
	text-transform: uppercase;
	font-size: 1.5em;
	height: 3.3em;
	word-spacing: 2em;
	border-radius: 10px;
}
#results {
/*	height: 500px;
	overflow: auto;
	border: 1px solid gray;*/
}

.entry {
	background-color: lightcyan;
	margin: 5px;
	width: 120px;
	display: inline-block;
	word-wrap: break-word;
	text-align: center;
	vertical-align: top;
}
.svg-wrapper {
	background: beige;
	text-align: center;
}
	.entry .svg-wrapper svg {
		height: 70px;
		max-width: 70px;
	}
span.main-label {
	display: block;
	margin: 10px 0;
}
.usymbols, .usymbols span {
	letter-spacing: 0.8em;
	border-top: 2px dashed #ccc;
	font-family: 'SignWriting 2010';
	font-weight: normal;
	line-height: 0.1em;
}
table#handlist {
	background-color: #ccc;
	width: 100%;
	/* Optional: Make Columns equal widths */
	/*table-layout: fixed;*/
}
/* Thicken Borders */
table, table td {
	border: 1px solid #ccc;
}
table td {
	vertical-align: middle;
	position: relative;
}

table#handlist tr#fiveHandCategories td {
	font-size: 2.0em;
	position: relative;
}
table#handlist tr#swroot td {
	font-size: 1.5em;
	
	/*padding-top: 8px;*/
	/*padding-bottom: 2px;*/
	
}

table#handlist tr#kleafsymbols td {
	/*background-color: transparent;*/
	background: #eee;
}

table#handlist tr td {
	background-color: #eee;
	vertical-align: top;
	text-align: center;
	padding: 0;
	margin: 0;
}
	table#handlist div.unicode-symbols {
		/*background-color: beige;*/
		font-family: 'SignWriting 2010';
		line-height: 3.0em;
	}
	/* Fix for SignWriting 2010 Offset */
	table#handlist div.unicode-symbols a {
		position: relative;
		border: 1px solid gray;
		margin-right: 5px;
		margin-bottom: 5px;
		border-radius: 3px;
	}

	table#handlist div.unicode-symbols a span {
		/*border: 1px dashed orange;*/
		padding: 0 5px;
		position: relative;
		top: 10px;
	}
table a {
	text-decoration: none;
}
a.td-emoji {
	width: 100%;
	display: block;
	margin: auto;
}
a.td-emoji:hover {
	background-color: darkgray;
}
a.td-emoji:active {
	background-color: white;
}

.unicode-symbols a:link, .unicode-symbols a:visited{
	color: blue;
	text-decoration: none;
}
.unicode-symbols a:hover {
	color: white;
	background-color: darkgray;
}
.unicode-symbols a:active {
	color: red;
}

span.buttoned, a.buttoned {
	border: 1px solid gray;
	border-radius: 8px;
	background-color: #eee;
}
a.buttoned {
	min-height: 30px;
	text-decoration: none;
	display: block;
	text-align: center;
}
a.buttoned:hover {
	background-color: darkgray;	
}
#displaySwLeavesButton {

}

</style>
</head>

<body>
	<div id="content-wrapper">
		<div id="upper-wrapper">
			<div id="results-text"></div>
			<div id="results"></div>
		</div>
		<div id="keyboard-area">
			<input id="inputArea" type="text" name="gloss-entry" placeholder="...">
		</div>
	</div>
</body>

<script>
	var displaySwLeavesButton_html = '<a href="#" id="displaySwLeavesButton" class="buttoned">ü§ì Expand / Collapse </a>'
	$('#keyboard-area').prepend(displaySwLeavesButton_html);
	$('#displaySwLeavesButton').click(function() {
		$('tr#kleafsymbols').toggle();
		updateUpperHeight();
	});
	// Values
	var swHandshapeRoots = ["S10000", "S10e00", "S11e00", "S14400", "S14c00", "S18600", "S1a400", "S1ba00", "S1cd00", "S1f500"]; // default 1,2,3,4,5,6,7,8,9,10 order.
	var displayOrder_num = [1,9,2,3,4,5,10,6,7,8];

	var swroot_fiveHand_lookup = {
		1: "‚òù",
		9: "‚òù",
		2: "‚úå",
		3: "‚úå",
		4: "üñê",
		5: "üñê",
		10: "üëç",
		6: "ü§ò",
		7: "ü§ò",
		8: "ü§ò",
	}

	// One-Time Generation.
	// Create a ancestryLookup for swLeafSymbols from swRootSymbolCategories // At publication, can be ported to a separate js file.
	var swleaf_parents_lookup = {};
	for (var i=0; i<swHandshapeRoots.length; i++) {
		var swroot_num = displayOrder_num[i];
		var swroot_fsw = swHandshapeRoots[swroot_num-1];
		var swroot_unicode = numberToEmoji_emoji(swroot_num);
		var fiveHand_emoji = swroot_fiveHand_lookup[swroot_num];

		var leafs = swRootSymbolCategories[swroot_fsw];
		for (var j=0; j<leafs.length; j++) {
			var leaf_fsw = leafs[j];
			var leaf_unicode = findUnicode8SuttonSymbols(leaf_fsw)[0];
			swleaf_parents_lookup[leaf_unicode] = [fiveHand_emoji, swroot_unicode];
		}
	}

	// Global Function
	function findUnicode8SuttonSymbols(fsw) {
		var symbols = fsw.match(/S.{5}/g);

		var u8symbols = [];
		for (var i=0; i<symbols.length; i++) {
			// Convert SignWriting Symbol Key - to Unicode
			var symbol = symbols[i];
			var hexkey = symbol.substring(1);
			hexkey = hexkey.substring(0, hexkey.length - 2); // Strip down to first 3 numbers (as that's all that's currently supported in unicode8)
			var hexvalue_dec = parseInt(hexkey, 16);

			var base_zeroValue_str = "1D700"; // because unicode8 starts at 1D800, and sw starts at 100.
			var unicodeHexValue_dec = hexvalue_dec + parseInt(base_zeroValue_str, 16);

			var u8 = String.fromCodePoint(unicodeHexValue_dec); // <- Ah I see, I wanted String.fromCodePoint, NOT fromCharCode!! - http://xahlee.info/js/js_unicode_code_point.html

			u8symbols.push(u8);
		}
		return u8symbols;
	}

	function numberToEmoji_emoji(number) {
		number = Math.round(number);
		if (number <0 || number > 10) { number = "#"; }
		if (number == 10) { return "üîü"; }
		return number+"‚É£";
	}

	// Add SearchTerm (Updateable) (To be solidified as a separate file in Production)
	for (var i=0; i<signPuddleEntries.length; i++) {
		var entry = signPuddleEntries[i];
		if (entry.term != undefined) {
			var fsw = entry.term[0];
			if (typeof fsw !== 'object') { // weirdly enough, some entry.term don't contain an FSW, but do contain a 'mainLabel'
				// A.
				// entry['unicode8searchTerms'] = fsw;
				// B.
				// var usymbols = findUnicode8SuttonSymbols(fsw);
				// entry['unicode8searchTerms'] = usymbols.join(" ");
				// C. (adding parentLookup)
				var usymbols = findUnicode8SuttonSymbols(fsw);
				for (var j=0; j<usymbols.length; j++) {
					var s = usymbols[j];
					var parents = swleaf_parents_lookup[s];
					if (parents) { usymbols[j] = parents.join("")+s; }
				}
				// entry['unicode8searchTerms'] = usymbols.join(" ");
				// C+. (~optional) (~adding mainLabel)
				var mainLabel = "";
				if (entry.term.length > 1) { mainLabel = entry.term[1].__cdata; }
				entry['unicode8searchTerms'] = usymbols.join(" ");
				entry['mainLabel'] = mainLabel;

			}
		}
	}
</script>

<script>
	// LOAD BUTTONS
	var table = '<table id="handlist">';
	// Populate 5-Hand-Categories
	var fiveHandCategories_tableFormat = [
		{"emoji":"‚òù", "colspan":"2", "index":0},
		{"emoji":"‚úå", "colspan":"2", "index":1},
		{"emoji":"üñê", "colspan":"2", "index":2},
		{"emoji":"üëç", "colspan":"1", "index":3},
		{"emoji":"ü§ò", "colspan":"3", "index":4},
	];
	var tr = '<tr id="fiveHandCategories">';
	for (var i=0; i<fiveHandCategories_tableFormat.length; i++) {
		var e = fiveHandCategories_tableFormat[i];
		var cha = '<span class="buttoned">'+e.emoji+'</span>'
		var html = '<a href="#" class="kfhemoji td-emoji" id="kfh'+e.index+'">'+cha+'</a>'
		tr += '<td colspan="'+ e.colspan +'">' + html + '</td>';
	}
	table += tr;
	// Populate SW_Root Row
	tr = '<tr id="swroot">';
	for (var i=0; i<displayOrder_num.length; i++) {
		var swHandshapeRoots_id = displayOrder_num[i]-1;
		var swroot = swHandshapeRoots[swHandshapeRoots_id];
		var numberSymbol_html = numberToEmoji_emoji(swHandshapeRoots_id+1);
		var td = "<td>"+'<a href="#" class="kswroot td-emoji" id="kswr'+displayOrder_num[i]+'">'+numberSymbol_html+"</div></td>";
		tr += td;
	}
	tr += "</tr>";
	table += tr;
	// Populate Sub-Symbols Row
	tr = '<tr id="kleafsymbols">';
	for (var i=0; i<displayOrder_num.length; i++) {
		var swHandshapeRoots_id = displayOrder_num[i]-1;
		var swroot = swHandshapeRoots[swHandshapeRoots_id];
		
		var childSymbols = swRootSymbolCategories[swroot];
		var html = '<div class="unicode-symbols">'
		for (var j=0; j<childSymbols.length; j++) {
			var childSymbol = childSymbols[j];
			var usymbol = findUnicode8SuttonSymbols(childSymbol)[0];
			var id = 'k'+childSymbol;
			html += '<a href="#" class="kleafsymbol" id="'+id+'"><span>'+usymbol+'</span></a> ';
		}
		html += '</div>'

		tr += "<td>"+html+"</td>";
	}
	tr += "</tr>";
	table += tr;
	table += "</table>"
	$('#keyboard-area').append(table);



	// Add Click-Actions
	$('.kleafsymbol').on('click', function(e) {
		e.preventDefault();
		var symbol_str = $(this).attr('id');
		var symbol_unicode = findUnicode8SuttonSymbols(symbol_str)[0];
		appendToSearchField(symbol_unicode);
	});
	$('.kswroot').on('click', function(e) {
		e.preventDefault();
		var num = $(this).attr('id'); // e.g. 'kswr10'
		num = num.substring(4, num.length);
		var emoji = numberToEmoji_emoji(num);
		appendToSearchField(emoji);
	});
	$('.kfhemoji').on('click', function(e) {
		e.preventDefault();
		var index = $(this).attr('id'); // e.g. 'kfh0'
		index = index.substring(3, index.length);
		var emoji = fiveHandCategories_tableFormat[index].emoji;
		appendToSearchField(emoji);
	});
	function appendToSearchField(value) {
		var inputVal = $('#inputArea').val();
		var oldVal = ""; if (inputVal.length !=0) {oldVal = inputVal + " ";}; // don't add space if empty.
		var newVal =  oldVal + value;
		$('#inputArea').val(newVal);

		refreshResultsFromInput();
	}


	// Create Sifter
	var sifter = new Sifter(signPuddleEntries);

	///////////////////
	$('#inputArea').focus();
	$('#inputArea').on('input', function(e) {
		e.preventDefault();
		refreshResultsFromInput();
	})

	refreshResultsFromInput(); // On Load // ~temp

	function refreshResultsFromInput() {
		// Get Value
		var value = $('#inputArea').val();
		value = value.trim();
		// ~temp
		if (value == "") {value = " ùß´"; }

		// Iniiate a sift search
		var results = sifter.search(value, {
			fields: ['mainLabel', 'unicode8searchTerms'],
			// sort: [{field: "mainLabel", direction:"asc"], // sifter.js only uses this sort for items with the same score, and scoring can't be easily disabled atm.
			conjunction: "and",
		});

		console.log(results);

		// TEMP: Filtering out items with no main label (this should be done in pre-processed data)
		for (var i=0; i<results.items.length; i++) {
			var _id = results.items[i].id;
			var entry = sifter.items[_id];

			var mainLabel = entry.mainLabel;
			if (!mainLabel) {
				results.items.splice(i, 1); // remove 1 item
				i--; // decrement i
			}
		}

		// TEMP-DEBUG: sort results by main label - temporarily useful for navigating searches based on SignSymbols - so they have a logical ordering. SignSymbols should actually be able to be filtered by mode symbols - when we introduce these, we can remove this function.
		function sort_withNumbersAfterLetters(a,b) {
			// can just ad zzz in front
			var a1 = a.charAt(0);
			var b1 = b.charAt(0);
			if ( $.isNumeric(a1) ) { a = "Œ©" + a; }
			if ( $.isNumeric(b1) ) { b = "Œ©" + b; }
			return a.localeCompare(b);
		}
		function compareResultItem_mainLabel(a, b) {
			var aid = a.id;
			var bid = b.id;
			var aEntry = sifter.items[aid];
			var bEntry = sifter.items[bid];
			var aLabel = aEntry.mainLabel;
			var bLabel = bEntry.mainLabel;
			// return aLabel.localeCompare(bLabel);
			return sort_withNumbersAfterLetters(aLabel, bLabel);
		}
		results.items.sort(compareResultItem_mainLabel);

		// DISPLAY
		
		var displayLimit = 50; // maximum
		var displayText = "Displaying "+displayLimit+" of "+results.items.length+" signs. (Search terms need to be separated by spaces \" \".) (Chrome required to view.)";
		$('#results-text').text(displayText);

		// Display Results
		var resultsHtml = '';
		for (var i=0; i<results.items.length; i++) {
			var _id = results.items[i].id;
			var entry = sifter.items[_id];

			var id = entry._id;
			if (entry.term.length == undefined) {continue;}

			var fsw = entry.term[0];

			var mainLabel = entry.mainLabel;
			if (!mainLabel) { mainLabel = "‚Ä¶?‚Ä¶"; }

			// var mainLabel = "_?_";
			// if (entry.term.length > 1) { mainLabel = entry.term[1].__cdata; }

			var symbols = findUnicode8SuttonSymbols(fsw);

			var divHtml = '<div id="e'+id+'" class="entry">';
			divHtml += '<div class="svg-wrapper"></div>'
			divHtml += '<span class="main-label">' + mainLabel + '</span>';
			// divHtml += '<span class="usymbols">' + entry.unicode8searchTerms + '</span>';
			divHtml += '<span class="usymbols">' + symbols.join('') + '</span>'; // <- Weirdly enough, in Safari, this is the only config that really works. (xx.join(), xx.join('</span><span>') xx.join(' ') ) - it's the same even if it's changed to a <div> container // Assigning CSS Content:Before doesn't work either.
			divHtml += '</div>';
			resultsHtml += divHtml;

			// Load SVG
			loadSvgToEntry(id, fsw);

			if (i>displayLimit) { break; }
		}
		$('#results').html(resultsHtml);
	}

	function loadSvgToEntry(id, fsw) {
		var url = "https://swserver.wmflabs.org/svg/";
		url += fsw;
		$.get(url, function(data) {
			$('#e'+id+' .svg-wrapper').html(data.firstChild);
		});
	}

</script>

<script>

	heightCheck();

	// RESIZE Handling
	$( window ).resize(function() {
		heightCheck();
	});
	function heightCheck() {
		// Height Check
		var mainHeight = $('#content-wrapper').outerHeight(); // same as windowHeight // $(window).height();

		$('tr#kleafsymbols').show();
		$('displaySwLeavesButton').show();

		var keyboardHeight_current = $('#keyboard-area').outerHeight();
		$('tr#kleafsymbols').hide();
		var keyboardHeight_withoutLeafs = $('#keyboard-area').outerHeight();
		$('tr#kleafsymbols').show();
		var keyboardHeight_withLeafs = $('#keyboard-area').outerHeight();

		$('tr#kleafsymbols').show();
		$('displaySwLeavesButton').show();

		if (keyboardHeight_withLeafs > mainHeight*0.75) {
			$('tr#kleafsymbols').hide();
			keyboardHeight_current = $('#keyboard-area').outerHeight();
		}

		// console.log(contentWrapperHeight, windowHeight, keyboardHeight);

		
		updateUpperHeight();
	}
	function updateUpperHeight() {
		var mainHeight = $('#content-wrapper').outerHeight(); // same as windowHeight // $(window).height();

		var keyboardHeight_current = $('#keyboard-area').outerHeight();

		// Update height // (this seems convoluted/impossible in css, hence the js)
		var upperHeight = parseInt(mainHeight - keyboardHeight_current);
		$('#upper-wrapper').height(upperHeight);	
	}

</script>

</html>